@model Scrapuncle.Models.DealerProfile
@{
    ViewData["Title"] = "Dealer Profile";
    Layout = "~/Views/Shared/_DealerLayout.cshtml";
}

<div class="container-fluid p-0 bg-success bg-opacity-25">
    <div class="py-4 px-3 px-md-4">
        <div class="text-center mb-4">
            <h2 class="fw-bold text-dark">My Profile</h2>
            <p class="text-dark text-opacity-75">Update your account details and serviceable areas</p>
        </div>

        <div class="row justify-content-center g-0">
            <div class="col-12 col-md-11 col-lg-9 col-xl-8">
                <div class="card border-0 shadow-lg rounded-4 overflow-hidden bg-white">
                    <div class="card-body p-3 p-md-4">
                        <form enctype="multipart/form-data" asp-action="Profile" method="post" id="profileForm">
                            <!-- profile picture -->
                            <div class="text-center mb-4">
                                <div class="position-relative d-inline-block">
                                    <img id="profileImage"
                                         src="@Url.Content(Model.ExistingProfileImagePath ?? "~/images/default-profile.png")"
                                         alt="Profile Picture"
                                         class="rounded-circle border border-3 border-success shadow"
                                         style="width: 140px; height: 140px; object-fit: cover;">
                                    <label for="profilePicInput"
                                           class="position-absolute bottom-0 end-0 bg-white border border-success rounded-circle d-flex justify-content-center align-items-center shadow"
                                           style="width: 40px; height: 40px; cursor: pointer;">
                                        <i class="fas fa-camera text-success"></i>
                                    </label>
                                    <input type="file" asp-for="ProfileImage" accept="image/*" id="profilePicInput" class="d-none">
                                </div>
                            </div>

                            <!-- fields -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Full Name <span class="text-danger">*</span></label>
                                    <input type="text" asp-for="FullName" class="form-control shadow-sm" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Business Name <span class="text-danger">*</span></label>
                                    <input type="text" asp-for="BusinessName" class="form-control shadow-sm" />
                                </div>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control shadow-sm" value="@User.Identity.Name" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                                    <input type="tel" asp-for="PhoneNumber" class="form-control shadow-sm" />
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Location/City <span class="text-danger">*</span></label>
                                <input type="text" asp-for="Location" class="form-control shadow-sm" />
                            </div>

                            <!-- pincodes -->
                            <div class="mb-3">
                                <label class="form-label">Serviceable Pincodes <span class="text-danger">*</span></label>
                                <div id="pincodeContainer" class="form-control d-flex flex-wrap gap-2 p-2 shadow-sm" style="min-height: 58px;">
                                    <input type="text" id="pincodeInput" class="border-0 flex-grow-1" placeholder="Enter pincode & press Enter">
                                </div>
                                <small class="text-muted">Only 6-digit pincodes allowed. Press Enter to add, click ❌ to remove.</small>

                                <input type="hidden" asp-for="ServiceablePincodes" id="hiddenPincodes" value="@Model.ServiceablePincodes" />
                            </div>

                            <div class="text-end mt-4">
                                <button type="submit" class="btn btn-success px-4 py-2 rounded-pill shadow-sm">
                                    <i class="fas fa-save me-2"></i> Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('profilePicInput').addEventListener('change', function (e) {
        var file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
            var reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('profileImage').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    var pincodeContainer = document.getElementById("pincodeContainer");
    var pincodeInput = document.getElementById("pincodeInput");
    var hiddenPincodes = document.getElementById("hiddenPincodes");

    function isValidPincode(value) {
        return /^\d{6}$/.test(value);
    }

    function pincodeExists(value) {
        var tags = pincodeContainer.getElementsByClassName("badge");
        for (var i = 0; i < tags.length; i++) {
            if (tags[i].textContent.trim().startsWith(value)) {
                return true;
            }
        }
        return false;
    }

    function createPincodeTag(value, silent = false) {
        if (!isValidPincode(value)) {
            if (!silent) alert("Please enter a valid 6-digit pincode.");
            return;
        }

        if (pincodeExists(value)) {
            if (!silent) alert("Pincode already added.");
            return;
        }

        var tag = document.createElement("span");
        tag.className = "badge bg-success d-flex align-items-center gap-1 px-2 py-1";
        tag.innerHTML = value + ' <button type="button" class="btn-close btn-close-white btn-sm ms-2"></button>';

        tag.querySelector("button").addEventListener("click", function () {
            tag.remove();
        });

        pincodeContainer.insertBefore(tag, pincodeInput);
    }

    pincodeInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && pincodeInput.value.trim() !== "") {
            e.preventDefault();
            createPincodeTag(pincodeInput.value.trim());
            pincodeInput.value = "";
        }
    });

    // Prepopulate pincodes from hidden field
    document.addEventListener("DOMContentLoaded", function () {
        var initial = hiddenPincodes.value;
        if (initial) {
            initial.split(',').forEach(function (pin) {
                if (pin.trim()) {
                    createPincodeTag(pin.trim(), true); // silent mode
                }
            });
        }
    });

    document.getElementById("profileForm").addEventListener("submit", function (e) {
        var fullName = document.querySelector('[name="FullName"]').value.trim();
        var businessName = document.querySelector('[name="BusinessName"]').value.trim();
        var phoneNumber = document.querySelector('[name="PhoneNumber"]').value.trim();
        var location = document.querySelector('[name="Location"]').value.trim();
        var pincodes = pincodeContainer.getElementsByClassName("badge");

        if (!fullName || !businessName || !location) {
            alert("Please fill in all required fields.");
            e.preventDefault();
            return;
        }

        if (!/^\d{11}$/.test(phoneNumber)) {
            alert("Enter a valid phone number (11 digits).");
            e.preventDefault();
            return;
        }

        if (pincodes.length === 0) {
            alert("Add at least one pincode.");
            e.preventDefault();
            return;
        }

        // Serialize
        var pinList = [];
        for (var i = 0; i < pincodes.length; i++) {
            pinList.push(pincodes[i].textContent.trim().slice(0, 6));
        }
        hiddenPincodes.value = pinList.join(",");
    });
</script>
